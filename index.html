<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Access-Control-Allow-Origin" content="*"/>
    <title>D3 World Map</title>
    <style>
    body {
        background-color: #363945;
    }
    .stateLabel{
  display: block;   /* hide all country labels by default */
}
.statecases{
  display: none;   /* hide all country labels by default */
}
#rect{
    fill:blue ;
}

.county{
    fill:none;
    cursor: pointer;
}

</style> 
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://d3js.org/topojson.v2.min.js"></script>
    <script src="./d3-simple-slider.js"></script>

</head>
<body onmousewheel= centerNode()>
<div id = "slider">
    <p id = 'slider-simple'></p>
</div>
<div id = "covidmap"></div>
<script type="text/javascript">
const width = 900;
const height = 600;

var svg = d3.select("#covidmap").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("id", "svg")

var projection = d3.geoAlbersUsa()
    .translate([width/2 , height / 2]) // translate to center of screen
    .scale([1000]); // scale things down so see entire US

var path = d3.geoPath().projection(projection);
// countriesGroup = svg.append("g").attr("id", "map");

var maxZoom;
var minZoom;


function getTextBox(selection) {
  selection.each(function(d) {
    d.bbox = this.getBBox();
  });
}

const colorScale = d3.scaleLinear()
    .domain([0, 10000000])
        .range(["#00F200", "#00BC4C", "#00806D", "#85FB44"].reverse());



function initiateZoom() {
  // Define a "minzoom" whereby the "Countries" is as small possible without leaving white space at top/bottom or sides
  minZoom = Math.max(d3.select("#covidmap").style("width") / width, d3.select("#covidmap").style("height") / height);
  // set max zoom to a suitable factor of this value
  maxZoom = 20 * minZoom;
  // set extent of zoom to chosen values
  // set translate extent so that panning can't cause map to move out of viewport
  zoom
    .scaleExtent([minZoom, maxZoom])
    .translateExtent([[0, 0], [width, height]])
  ;
  // define X and Y offset for centre of map to be shown in centre of holder
  midX = (d3.select("#covidmap").style("width") - minZoom * width) / 2;
  midY = (d3.select("#covidmap").style("height") - minZoom * height) / 2;
  // change zoom transform to min zoom and centre offsets
  svg.call(zoom.transform, d3.zoomIdentity.translate(midX, midY).scale(minZoom));
}

// zoom to show a bounding box, with optional additional padding as percentage of box size
function boxZoom(box, centroid, paddingPerc) {
  minXY = box[0];
  maxXY = box[1];
  // find size of map area defined
  zoomWidth = Math.abs(minXY[0] - maxXY[0]);
  zoomHeight = Math.abs(minXY[1] - maxXY[1]);
  // find midpoint of map area defined
  zoomMidX = centroid[0];
  zoomMidY = centroid[1];
  // increase map area to include padding
  zoomWidth = zoomWidth * (1 + paddingPerc / 100);
  zoomHeight = zoomHeight * (1 + paddingPerc / 100);
  // find scale required for area to fill svg
  
  maxXscale = width / zoomWidth;
  maxYscale = height / zoomHeight;
    zoomScale = Math.min(maxXscale, maxYscale);

  // Find screen pixel equivalent once scaled
  offsetX = zoomScale * zoomMidX;
  offsetY = zoomScale * zoomMidY;
  // Find offset to centre, making sure no gap at left or top of holder
  dleft = Math.min(0, width / 2 - offsetX);
  dtop = Math.min(0, height / 2 - offsetY);
  return svg
    .transition()
    .duration(500)
    .call(
      zoom.transform,
      d3.zoomIdentity.translate(dleft, dtop).scale(zoomScale)
    );
}

function centerNode(){
    initiateZoom();    
}

function resize(){
    svg
    .attr("width",width)
    .attr("height",height);
 initiateZoom();
}

// Create function to apply zoom to countriesGroup
function zoomed() {
    
  t = d3
    .event
    .transform;
    countriesGroup
    .attr("transform","translate(" + [t.x, t.y] + ")scale(" + t.k + ")")
  ;
}

// Define map zoom behaviour
var zoom = d3
  .zoom()
  .on("zoom", zoomed);


d3.queue()
    .defer(d3.json, "https://gist.githubusercontent.com/Bradleykingz/3aa5206b6819a3c38b5d73cb814ed470/raw/a476b9098ba0244718b496697c5b350460d32f99/us-states.json")
    .defer(d3.json,"https://github.com/wajahatkhan97/finalProject/blob/main/localization.json" )
    .defer(d3.json,"/us.json" )
    .defer(d3.json,"/unemployee.json" )
    .await(ready)
function ready(error, stateCoord, data, countiesFeatures, statedata) {
            // console.log(statedata.UnemploymentMedianIncome[0].FIPS_Code)
        //for each county data iterate over and combine FIPS code //goal is to use state name to display only specific state county
    // .attr("id", function(d,i){
    //          return "county" + d.properties.name;
    //      })
        var activeState = null;
            const count = 0;
            var year = d3.timeFormat("%Y") //will be used to format year
            var sliderYear;
            countriesGroup = svg.append("g").attr("id", "map");

            var parseTime = d3.timeParse("%Y");
            //show default map
           // populateCounties();
            runSlide(year(parseTime("2020")), 0);
            a1 = parseTime("2020")
            a2 = parseTime("2023")
            var sliderStep = d3
            .sliderBottom()
            .domain([a1,a2])
            .step(1000 * 60 * 60 * 24 * 366)
            .width(300)
            .tickFormat(d3.timeFormat('%Y'))
            .tickValues(3)
            .on('onchange', (val) => {               
               sliderYear = year(val);
               d3.select('#slider-simple').text(val);
               d3.select("#total").style("display", "none")
            d3.select(".unemployeetotal").remove(); 
            d3.select("#bargraph").remove();
            d3.select("#xaxis").remove();
            d3.select("#yaxis").remove();
            runSlide(sliderYear, 1)

            });

            d3.select('#slider')
            .append('svg')
            .attr('width', 600)
            .attr('height', 100)
            .append('g')
            .attr('transform', 'translate(30,30)')
            .call(sliderStep)
            var counties; 
       
            function runSlide(sliderYear, count) {
                counties = topojson.feature(countiesFeatures,countiesFeatures.objects.counties).features;
                if  (count === 0) {
                    d3.select("#barchart").transition().duration(500).style("visibility", "hidden");//temporary
                    d3.select("#unemployementRate").transition().duration(500).style("visibility", "hidden");//temporary

                }
            for (let i =0 ; i < stateCoord.features.length; i++) {
               // console.log(data[i].state);
               for (let j  =0; j < data.length; j++) {
                if (stateCoord.features[i].properties.name == data[j]['administrative_area_level_2'] && data[j]['year'] == sliderYear) {
                    stateCoord.features[i].properties["cases"] = data[j]['confirmed']
                }
            }
            
        }

        //todo: fix the code to unselect when select any other state or slider is moved (year is working fine)
        //todo: zooming in run multiple times (check logs of zoomed)

        //IMPORTANT: Change of requirement for now (have to meet minimum requirement first) 
        //when user click on state we will open up a rectangular bar showing average data of that state(unemployement dataset)

        //todo: features to add (when a user hover over the map display state name, confirmed cases, deaths, unemployement rate, average cases of all counties)
        //tood: clicking on the state will take to new scene which will display 2 more scenes one county cases filter by year
        //and second scene showing unemployement from 2020 to 2023 ---- look at Unemployemenet csv file

        /*
        The scenes should follow a template for visual consistency and follow an order to best convey the message. One way to 
        implement different scenes is to make each a separate web page. Another way is to use d3.select(id).html = "" 
        to clear the contents of a container element (e.g. an SVG element) and then repopulate that element using .append().
        */
       var totalUnemployed = 0;
       var totalEmployeed = 0;
   scenetwochart(activeState);
scenethreechart(activeState);
        countriesGroup.selectAll("path")
        .data(stateCoord.features)
        .enter()
        .append('path')
        .attr("d", path)
        .attr("cursor", "pointer")
        .attr("class", "country")
        .style("fill", function(d) {
             return colorScale(d.properties.cases)
         }).attr("id", function(d,i){
             return "country"+d.properties.name;
         })
         .on("mouseover", function(d, i) {
          d3.select("#stateLabel" + d.properties.name.replace(/ +/g, "")).style("display", "block");
      })
      .on("click", function(d, i) {
            // show counties with covid cases

    // console.log(statedata)
      d3.select("#statecases" + d.properties.cases).style("display", "block");
      
      d3.select("#svg").transition().duration(500).style("visibility", "hidden");//delete
      d3.select("#barchart").transition().duration(500).style("visibility", "visible");//temporary
      activeState = d;
      scenetwochart(d)

      //create new svg

   }).on("mouseout", function(d, i) {
          d3.select("#stateLabel" + d.properties.name.replace(/ +/g, "")).style("display", "none");
      }).on("slide", function(d, i) {
            //show counties with covid cases
            console.log("te")
      d3.select("#statecases" + d.properties.cases).style("display", "none");
   

    })


function scenetwochart(d){
    if (d === null) {
        createStateBarChart();

    }
    if (d !== null) {
        var state = d.properties.name;
        // d['State'] == abbrState(state,"abbr") && 
        statedata.UnemploymentMedianIncome.filter(function(d){
if (state === d['Area_Name']) {
    totalUnemployed = totalUnemployed  + +d['Unemployed' + '_' + sliderYear].replace(",","");
    totalEmployeed = totalEmployeed + +d['Employed' + '_' + sliderYear].replaceAll(",","");
}})

// console.log(totalUnemployed)
// console.log(totalEmployeed)
var data = [totalUnemployed,totalEmployeed]
var max = d3.max(data);
// console.log(d3.select("#barchart").append('g'))
var x = d3.scaleBand().domain([0,1]).range([0,400]).padding(0.5)
var y = d3.scaleLinear().domain([0,max]).range([500,0])
var height = d3.scaleLinear().domain([0,max]).range([0,500]) 
d3.select("#barchart")
.append("g")
.attr("transform","translate(50,50)").attr("id", "bargraph").selectAll("#barchart").data(data).enter().append("rect")
.attr("x", function (d,i) {return x(i)})
.attr("y",function(d){return y(d)})
.attr("cursor", "pointer")
.attr("width", 33.3333)
.attr("height", function(i){return height(i)})
.attr("fill", "blue")
.on("mouseover", function(d, i) {
     unemployeeLabel(d, x(i), y(d));
    d3.select("#total").style("display", "block");
      }).on("mouseout", function(d, i) {
           d3.select("#total").style("display", "none")
            d3.select(".unemployeetotal").remove();
        }).on("click", function(d,i){
            scenethreechart(state);
})

d3.select("#barchart").append("g").attr("transform","translate(50,50)").attr("id", "xaxis").call(d3.axisLeft(y))

d3.select("#barchart").append("g").attr("transform","translate(50,550)").attr("id", "yaxis").call(d3.axisBottom(x).tickFormat(function(d,i){
    return i ===0? 'Unemployeed' : 'Employeed'
}))

    }
    }

    function scenethreechart(state){
        var counties = [];
        var unemployeement_rate=[];
        var domain  = [];
        var count = 0;
        const map1 = new Map();

        if (state === null) {
            createUnemployementStateBarChart();
        }

    if (state !== null) {
        
        // d['State'] == abbrState(state,"abbr") && 
        statedata.UnemploymentMedianIncome.filter(function(d){
if (d['State'] == abbrState(state,"abbr") && state !== d['Area_Name']) {
    //totalUnemployed = totalUnemployed  + +d['Unemployed' + '_' + sliderYear].replace(",","");
        counties.push(d['Area_Name']);
        unemployeement_rate.push(d['Unemployment_rate_2022']);
        map1.set(d['Unemployment_rate_2022'],d['Area_Name']); 
        domain.push(count);
        count = count + 1;

}})

// console.log(count)

// console.log(counties)
// console.log(map1)

var data = [totalUnemployed,totalEmployeed,100,200,400,10000,14120]
var max = d3.max(data);
// console.log(d3.select("#barchart").append('g'))
var x = d3.scaleBand().domain(domain).range([0,500]).padding(0.9)
var y = d3.scaleLinear().domain([0.0,15.0]).range([500,0])
var height = d3.scaleLinear().domain([0.0,15.0]).range([0,500]) 
d3.select("#unemployementRate")
.append("g")
.attr("transform","translate(50,50)").attr("id", "unemployementRate").selectAll("#unemployementRate").data(unemployeement_rate).enter().append("rect")
.attr("x", function (d,i) {return x(i)})
.attr("y",function(d){
    return y(d)})
.attr("cursor", "pointer")
.attr("width", 15.3333)
.attr("height", function(i){return height(i)})
.attr("fill", "blue")
.on("mouseover", function(d, i) {
     unemployeeLabel(d, x(i), y(d));
    d3.select("#total").style("display", "block");
      }).on("mouseout", function(d, i) {
           d3.select("#total").style("display", "none")
            d3.select(".unemployeetotal").remove();
        }).on("click", function(d,i){
            createUnemployementStateBarChart();
})
var x1 = d3.scaleBand().domain([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20]).range([500,0]);
d3.select("#unemployementRate").append("g").attr("transform","translate(50,50)").attr("id", "xaxis").call(d3.axisLeft(y))

d3.select("#unemployementRate").append("g").attr("transform","translate(50,550)").attr("id", "yaxis").call(d3.axisBottom(x1).tickFormat(function(d,i){
        
    var stateName = counties[d];
    return map1.get(unemployeement_rate[i])
}))

    }

    }

    function createStateBarChart(){
     d3.select("#covidmap").append("svg")
    .attr("width", width)
    .attr("height", height)
    .attr("id", "barchart")

    }
        
    function createUnemployementStateBarChart(){
     d3.select("#covidmap").append("svg")
    .attr("width", 2000)
    .attr("height", height)
    .attr("id", "unemployementRate")

    }
        

 function unemployeeLabel(d, x, y){
     var totalNumber = d;
    unemployeed = d3.selectAll('#bargraph')
   .append("g")
   .attr("class", "unemployeetotal")
   .attr("id","total")
   .on("mouseover", function(d, i) {
          d3.select(this).style("display", "block");
      }).on("mouseout", function(d, i) {
           d3.select(this).style("display", "none")})
   

unemployeed
   .append("text")
   .attr("class", "countryName")
   .style("text-anchor", "middle")
   .attr("dx", x)
   .attr("dy", y)
   .text(function(d) {
    //   / console.log(totalNumber)
      return totalNumber;
   })
.attr("text-anchor","middle")
.attr('font-size','12pt');
   

 }   
   
countryLabels = countriesGroup.selectAll('g')
   .data(stateCoord.features)
   .enter()
   .append("g")
   .attr("class", "stateLabel")
   .attr("id", function(d) {
      return "stateLabel" + d.properties.name.replace(/ +/g, "");
   })
   .attr("transform", function(d) {
      return (
         "translate(" + path.centroid(d)[0] + "," + path.centroid(d)[1] + ")"
      );
   }).on("mouseover", function(d, i) {
          d3.select(this).style("display", "block");
      }).on("mouseout", function(d, i) {
           d3.select(this).style("display", "none")})
   

   countryLabels
   .append("text")
   .attr("class", "countryName")
   .style("text-anchor", "middle")
   .attr("dx", 0)
   .attr("dy", 0)
   .text(function(d) {
      return d.properties.name;
   })
.attr("text-anchor","middle")
.attr('font-size','12pt');
   

   stateCases= countriesGroup.selectAll("svg").data(stateCoord.features)
      .enter()
   .append("g")
   .attr("class", "statecases")
   .attr("id", function(d) {
      return "statecases" + d.properties.cases;
   })
   .attr("transform", function(d) {
      return (
         "translate(" + path.centroid(d)[0] + "," + path.centroid(d)[1] + ")"
      );
   }).on("mouseover", function(d, i) {
          d3.select(this).style("display", "block");
      }).on("mouseout", function(d, i) {
           d3.select(this).style("display", "none")}); 

   stateCases
   .append("text").attr("class", "statecase")
   .style("text-anchor", "middle")
   .attr("dx", 0)
   .attr("dy", 0)
   .text(function(d) {
      return d.properties.cases;
   })

 
}

function abbrState(input, to){
    
    var states = [
        ['Arizona', 'AZ'],
        ['Alabama', 'AL'],
        ['Alaska', 'AK'],
        ['Arkansas', 'AR'],
        ['California', 'CA'],
        ['Colorado', 'CO'],
        ['Connecticut', 'CT'],
        ['Delaware', 'DE'],
        ['Florida', 'FL'],
        ['Georgia', 'GA'],
        ['Hawaii', 'HI'],
        ['Idaho', 'ID'],
        ['Illinois', 'IL'],
        ['Indiana', 'IN'],
        ['Iowa', 'IA'],
        ['Kansas', 'KS'],
        ['Kentucky', 'KY'],
        ['Louisiana', 'LA'],
        ['Maine', 'ME'],
        ['Maryland', 'MD'],
        ['Massachusetts', 'MA'],
        ['Michigan', 'MI'],
        ['Minnesota', 'MN'],
        ['Mississippi', 'MS'],
        ['Missouri', 'MO'],
        ['Montana', 'MT'],
        ['Nebraska', 'NE'],
        ['Nevada', 'NV'],
        ['New Hampshire', 'NH'],
        ['New Jersey', 'NJ'],
        ['New Mexico', 'NM'],
        ['New York', 'NY'],
        ['North Carolina', 'NC'],
        ['North Dakota', 'ND'],
        ['Ohio', 'OH'],
        ['Oklahoma', 'OK'],
        ['Oregon', 'OR'],
        ['Pennsylvania', 'PA'],
        ['Rhode Island', 'RI'],
        ['South Carolina', 'SC'],
        ['South Dakota', 'SD'],
        ['Tennessee', 'TN'],
        ['Texas', 'TX'],
        ['Utah', 'UT'],
        ['Vermont', 'VT'],
        ['Virginia', 'VA'],
        ['Washington', 'WA'],
        ['West Virginia', 'WV'],
        ['Wisconsin', 'WI'],
        ['Wyoming', 'WY'],
    ];

    if (to == 'abbr'){
        input = input.replace(/\w\S*/g, function(txt){return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();});
        for(i = 0; i < states.length; i++){
            if(states[i][0] == input){
                return(states[i][1]);
            }
        }    
    } else if (to == 'name'){
        input = input.toUpperCase();
        for(i = 0; i < states.length; i++){
            if(states[i][1] == input){
                return(states[i][0]);
            }
        }    
    }
}
}

</script>

<!-- // var x_axis = d3.axisBottom(x)
//         .tickFormat("unemployee").ticks(2); 
// var y_axis = d3.axisLeft(y)
//  //       .tickFormat(d3.format("s"));

// d3.select("#barchart").append("g").attr("transform","translate(50,50)").call(y_axis)

// d3.select("#barchart").append("g").attr("transform","translate(50,550)").call((x_axis))



//         var fipcodes = [];
//         var countiesState;
// boxZoom(path.bounds(d), path.centroid(d), 20);
//       for (let i =0 ; i < stateCoord.features.length; i++) {
//                // console.log(data[i].state);
//                for (let j  =0; j < data.length; j++) {
//                 if (stateCoord.features[i].properties.name == d.properties.name)
//                     {
//                         d3.select("#country"+d.properties.name).style("fill", "#fff")
//                         var abbreviation = abbrState(d.properties.name, "abbr");

//                         (statedata.UnemploymentMedianIncome.filter(function(d){
//                                 if (d['State'] == abbreviation) {
//                                     fipcodes.push(+d['FIPS_Code'])
//                                 }
//                         }))
//                      counties =  counties.filter(function(d){
//                           // console.log(d['id'])
//                            if (fipcodes.includes(d['id'])) {
//                                d['properties']['state'] = abbreviation;
//                             }
//                             return d;
//                        })
//                         break;
//                     }
//             }
//             }
//             populateCounties(d);
//           d3.selectAll("#countiesTX").style("fill", "black"); -->

</body>
</html>
